#!/bin/bash

#SBATCH --partition=gpu_h100
#SBATCH --gpus=1
#SBATCH --job-name=run_evaluation
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --time=2:00:00
#SBATCH --output=%x_%j.out


# Load necessary modules
module purge
module load 2024
module load CUDA/12.6.0
module load cuDNN/9.5.0.50-CUDA-12.6.0

# --- Environment Variables ---
# These must be set before running the script.
# - PROJECT_DIR: The root directory of the project.
# - CACHE_DIR: A designated directory for caching models, datasets, etc.

if [ -z "$PROJECT_DIR" ] || [ -z "$CACHE_DIR" ]; then
    echo "Error: PROJECT_DIR and CACHE_DIR environment variables must be set."
    exit 1
fi

# Set up Conda
export PATH="$HOME/miniconda3/bin:$PATH"
eval "$(conda shell.bash hook)"

# Set Hugging Face cache directories
export HF_HOME="${CACHE_DIR}"
export HUGGINGFACE_HUB_CACHE="${CACHE_DIR}/hub"
export TRANSFORMERS_CACHE="${CACHE_DIR}/transformers"
export HF_DATASETS_CACHE="${CACHE_DIR}/datasets"

mkdir -p "${HUGGINGFACE_HUB_CACHE}"
mkdir -p "${TRANSFORMERS_CACHE}"
mkdir -p "${HF_DATASETS_CACHE}"

# Activate the vllm environment
conda activate vllm

echo "================================================================================"
echo "Job Configuration:"
echo "Project Directory: ${PROJECT_DIR}"
echo "Cache Directory: ${CACHE_DIR}"
echo "Conda Environment: $CONDA_DEFAULT_ENV"
echo "================================================================================"

# Verify PyTorch and GPU access
echo "--- Checking PyTorch GPU Access ---"
srun python -uc "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available? {torch.cuda.is_available()}'); print(f'CUDA version built with: {torch.version.cuda}'); print(f'Device name: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \'N/A\'}'"
echo "---------------------------------"

# Set the path to the evaluation script
FILEPATH="${PROJECT_DIR}/evaluation/qwen_judge_v2.py"

if [ ! -f "$FILEPATH" ]; then
    echo "ERROR: Evaluation script not found at $FILEPATH"
    exit 1
fi

# Run the evaluation script
echo "[$(date)] Running evaluation script: $FILEPATH"
python "$FILEPATH"

echo "[$(date)] Evaluation finished."